(function(t){var n=t.pow=Math.pow,i=t.sqrt=Math.sqrt;t.abs=Math.abs,t.Type=function(t){var n=function(){this.initialize&&this.initialize.apply(this,arguments)};for(var i in t)t.hasOwnProperty(i)&&(n.prototype[i]=t[i]);return n};var r=function(t,n){this.x=t,this.y=n};r.prototype.toString=function(){return"("+this.x+", "+this.y+")"},t.point=function(t,n){return 1===arguments.length?new r(t[0],t[1]):new r(t,n)};var e=function(t,n){this.i=t,this.j=n};e.prototype.length=function(){return i(n(this.i,2)+n(this.j,2))},e.prototype.reverse=function(){return new e(-this.i,-this.j)},e.prototype.toString=function(){return"<"+this.i+", "+this.j+">"},t.vector=function(t,n){return 1===arguments.length?new e(t[0],t[1]):new e(n.x-t.x,n.y-t.y)}})(function(){return this.jeos={toString:"jeos",$:{}},this.jeos}()),function(t){t.angle=function(t){var n,i=0>t.i?-t.i:t.i,r=0>t.j?-t.j:t.j;return n=i>=r?r/i:2-i/r,0>t.i&&(n=4-n),0>t.j&&(n=8-n),n}}(function(){return this.jeos}()),function(t){t.normalPRP=function(t,n,i){var r=t.j*(i.y-n.y)+t.i*(i.x-n.x);return 0>r?1:r>0?2:0},t.clockWise=function(t){for(var n=0,i=0;t.length>i;i++){var r=t[i],e=t[(i+1)%t.length];n+=r.x*e.y-e.x*r.y}return n>0?-1:0>n?1:0},t.spd=function(n,i,r){var e=t.vector(n,r),o=e.i*i.j-e.j*i.i;return t.sqrt(o*o/(t.pow(i.i,2)+t.pow(i.j,2)))},t.prp=function(t,n,i){var r=n.i*(i.y-t.y)-n.j*(i.x-t.x);return r>0?1:0>r?2:0}}(function(){return this.jeos}()),function(t,n){t.remove=function(t,n){for(var i=[],r=0;t.length>r;r)n(t[r],r)?(i.push(t[r]),t.splice(r,1)):r++;return i},t.result=function(t){var n=[],i=function(){return 0===arguments.length?n:((!t||t(n,Array.prototype.slice.call(arguments,0)))&&n.push(Array.prototype.slice.call(arguments,0)),void 0)};return i.$content=n,i},n.Emitter=n.Type({on:function(t,n){this.$evt=this.$evt||{},this.$evt[t]=this.$evt[t]||[],this.$evt[t].push(n)},fire:function(t,n){this.$evt&&this.$evt[t]&&this.$evt[t].forEach(function(t){t&&t(n)})}})}(function(){return this.jeos.$}(),function(){return this.jeos}()),function(t){var n=t.vector,i=t.point,r=t.Edge=t.Type({initialize:function(t,i){this.p=t,this.q=i,this.pq=n(t,i)},normal:function(t){var i=this.pq.length(),r=-(this.pq.j*t)/i,e=this.pq.i*t/i;return n([r,e])},pointAt:function(t){return i(this.p.x+this.pq.i*t,this.p.y+this.pq.j*t)},toString:function(){return"Edge("+this.p+", "+this.q+")"}});r.from=function(t,n){return new r(i(t),i(n))}}(function(){return this.jeos}()),function(t){var n=t.Polygon=t.Type({initialize:function(n){this.edges=[],this.points=n;for(var i=0;n.length>i;i++){var r=n[i],e=n[(i+1)%n.length];this.edges.push(new t.Edge(r,e))}},edge:function(t){return this.edges[t]},isClockWise:function(){var n=t.clockWise(this.points);if(1===n)return!0;if(0===n)throw Error("Irregular polygon!");return!1},isCounterClockWise:function(){var n=t.clockWise(this.points);if(-1===n)return!0;if(0===n)throw Error("Irregular polygon!");return!1},reverse:function(){return new n(this.points.slice(0).reverse())}});n.from=function(i){return new n(i.map(function(n){return t.point(n)}))}}(function(){return this.jeos}()),function(t){t.indexOf=function(n,i,r){var e=i.x-n.x,o=i.y-n.y;return-(r.i*e+r.j*o)/(t.pow(r.i,2)+t.pow(r.j,2))}}(function(){return this.jeos}()),function(t){var n=function(n,i,r,e){var o=n.x-r.x,u=n.y-r.y,s=e.i*i.i+e.j*i.j,c=-((e.i*o+e.j*u)/s),p=n.x+c*i.i,f=n.y+c*i.j;return t.point(p,f)},i=function(t){return(t.ed-t.sd)/(t.ei-t.si)},r=t.Projection=t.Type({initialize:function(t,n,i,r){this.si=t,this.sd=n,this.ei=i,this.ed=r},valueAt:function(t){return this.si===t?this.sd:this.ei===t?this.ed:(void 0===this.$m&&(this.$m=i(this),this.$c=this.sd-this.$m*this.si),this.$m*t+this.$c)},toString:function(){return"[("+this.si+", "+this.sd+"), ("+this.ei+", "+this.ed+")]"}});r.from=function(i,e){var o=i.p,u=i.q,s=t.indexOf(o,e.p,e.pq),c=t.indexOf(u,e.p,e.pq);if(s>c){var p=o;o=u,u=p,p=c,c=s,s=p}0>s&&(o=n(o,i.pq,e.p,e.pq),s=0),c>1&&(u=n(u,i.pq,e.q,e.pq),c=1);var f=s,h=t.spd(e.p,e.pq,o),a=c,v=t.spd(e.p,e.pq,u);return new r(f,h,a,v)};var e=t.hasProjection=function(n,i){var r=t.prp(i.p,i.pq,n.p),e=t.prp(i.p,i.pq,n.q);if(!(1&(r|e)))return!1;var o=function(n){var r=t.normalPRP(i.pq,i.p,n),e=t.normalPRP(i.pq,i.q,n);return r|e},u=o(n.p),s=o(n.q),c=u!==s?!0:3===s;if(c){var p=t.angle(i.pq),f=t.angle(n.pq),h=t.abs(p-f);c=h>2&&6>h}return c};t.detectProjections=function(t,n){for(var i=[],r=0;t.length>r;r++){for(var o=[],u=0;t.length>u;u++)u!==r&&e(t[u],t[r])&&(n?o.push(n(t[u],t[r])):o.push(t[u]));i.push(o)}return i}}(function(){return this.jeos}()),function(t){var n=function(t){if(0>t.si)throw Error("Start index invalid!");if(t.ei>1)throw Error("End index invalid!")},i=function(t,i){if(n(t),n(i),t.si<i.si)return-1;if(i.si<t.si)return 1;if(t.sd<i.sd)return-1;if(i.sd<t.sd)return 1;if(t.ed<i.ed)return-1;if(i.ed<t.ed)return 1;if(t.ei<i.ei)return-1;if(i.ei<t.ei)return 1;throw Error("Ouch!")};t.shadows=function(t){return t.map(function(t){return r(t.slice(0).sort(i))})};var r=function(n){var i,r=t.$.result(function(t,n){if(t.length){var i=t[t.length-1][0],r=t[t.length-1][1];return i!==n[0]||r!==n[1]}return!0}),e=n.shift(),o=e.si,u=[],s=function(){t.$.remove(u,function(t){return o>=t.ei})},c=function(){var t=0,n=u.reduce(function(n,i,r){return i.valueAt(o)<n.valueAt(o)?(t=r,i):n});return u.splice(t,1),n};for(r(o,e.valueAt(o));n.length;){for(i=n.shift();e.ei<i.si;){if(!(e.ei>=o))throw Error("Unexpected!");o=e.ei,s(),r(o,e.valueAt(o)),e=c(),r(o,e.valueAt(o))}o=i.si,s(),i.valueAt(o)<e.valueAt(o)?(r(o,e.valueAt(o)),r(o,i.valueAt(o)),u.unshift(e),e=i):u.push(i)}for(o=e.ei,r(o,e.valueAt(o)),s();u.length;)e=c(),r(o,e.valueAt(o)),o!==e.ei&&(o=e.ei,r(o,e.valueAt(o))),s();return r()}}(function(){return this.jeos}()),function(t){var n=function(t,n){return t-n},i=function(t){return{$:t,x:[t.p.x,t.q.x].sort(n),y:[t.p.y,t.q.y].sort(n)}},r=function(t,n){return t.y[1]>n.y[1]?-1:n.y[1]>t.y[1]?1:t.x[0]<n.x[0]?-1:n.x[0]<t.x[0]?1:0},e=function(n,i){var r=t.prp(i.p,i.pq,n.p)|t.prp(i.p,i.pq,n.q),e=t.prp(n.p,n.pq,i.p)|t.prp(n.p,n.pq,i.q);return e===r?3===r:!1},o=function(n,i){var r=i.p.x-n.p.x,e=i.p.y-n.p.y,o=n.pq.i*i.pq.j-n.pq.j*i.pq.i,u=i.pq.j*r-i.pq.i*e,s=n.pq.j*r-n.pq.i*e;u/=o,s/=o;var c=n.p.x+u*n.pq.i,p=n.p.y+u*n.pq.j;return{point:t.point(c,p),i0:u,i1:s}};t.searchIntersections=function(n){n=n.map(i).sort(r);var u,s=t.$.result(),c=[],p=function(t){return t.y[0]>=u};return n.forEach(function(n){u=n.y[1],t.$.remove(c,p),c.forEach(function(t){e(n.$,t.$)&&s(n.$,t.$,o(n.$,t.$))}),c.push(n)}),s()}}(function(){return this.jeos}()),function(t){t.indexOf;var n=function(t){return{point:t,next:null,back:null}},i=function(n,i){return{$pN:n,$qN:i,p:n.point,q:i.point,pq:t.vector(n.point,i.point)}},r=function(t){for(var r=t.map(n),e=[],o=0;r.length>o;o++){var u=r[o],s=r[(o+1)%r.length];u.next=s,s.back=u,e.push(i(u,s))}return[r,e]},e=function(t,n,i){t.next=n,n.next=i,i.back=n,n.back=t},o=Math.max,u=Math.min,s=function(n){for(var i=[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],r=[i[0],i[1]],e=[];n&&!n.visited;)e.push(n.point),i[0]=u(i[0],n.point.x),i[1]=o(i[1],n.point.x),r[0]=u(r[0],n.point.y),r[1]=o(r[1],n.point.y),n.visited=!0,n=n.next;if(e.clockWise=t.clockWise(e),e.x=i,e.y=r,0===e.clockWise)throw Error("Error, unexpected 0 clockwise!\n"+e);return e.clockWise=1===e.clockWise,e},c=function(t){var n=[];return t.forEach(function(t){t.visited||n.push(s(t))}),n},p=function(t){return t.pq.j>0?t.$pN:0>t.pq.j?t.$qN.back:t.pq.i>0?t.$qN.back:0>t.pq.i?t.$pN:void 0},f=function(t){return t.pq.j>0?t.$pN.next:0>t.pq.j?t.$qN:t.pq.i>0?t.$qN:0>t.pq.i?t.$pN.next:void 0},h=function(t,n){return t.y>n.y?-1:n.y>t.y?1:t.x<n.x?-1:n.x>n.x?1:0},a=function(t,n){return h(t[2].point,n[2].point)},v=function(t,n){return n.x[0]<t.x[0]||n.x[1]>t.x[1]?!1:n.y[0]<t.y[0]||n.y[1]>t.y[1]?!1:!0},l=function(t,n){return v(t,n)?-1:v(n,t)?1:0},y=function(t){return{ring:t,childreen:null}},q=function(n){var i=n.shift(),r=function(n,i){for(var e,o=[],u=function(t){return v(e.ring,t.ring)};i.length;)e=i.shift(),e.childreen=r(e,t.$.remove(i,u)),o.push(e);return o.length?o:null};return i.childreen=r(i,n),i};t.sie=function(i){var o=r(i),u=o[1];o=o[0],t.searchIntersections(u).sort(a).forEach(function(t){var i=t[0],r=t[1],u=t[2],s=n(u.point),c=n(u.point),h=p(i),a=f(i),v=p(r),l=f(r);e(h,s,l),e(v,c,a),o.push(s),o.push(c)});var s=q(c(o).sort(l).map(y)),h=s.ring.slice(0);return s.childreen?s.childreen.filter(function(t){return t.ring.clockWise}).map(function(t){return t.ring.slice(0)}):[],[h]}}(function(){return this.jeos}()),function(t){var n=t.WeightedOffset=t.Type({initialize:function(n){this.polygon=n.isClockWise()?n.reverse():n,this.emitter=new t.Emitter},offset:function(n){var i=this.polygon.edges,r=t.detectProjections(i,function(n,i){return t.Projection.from(n,i)});this.emitter.fire("project",r);var e=t.shadows(r,n);this.emitter.fire("shadow",e);var o=e.map(function(r,e){var o=i[e];return r.map(function(i){var r=n(i[1]),e=o.normal(-r),u=o.pointAt(i[0]);return t.point(u.x+e.i,u.y+e.j)})});this.emitter.fire("offset",o);var u=t.sie(o.reduce(function(t,n){return t.concat(n)},[]));return u.map(function(t){return t.map(function(t){return[t.x,t.y]})})},on:function(t,n){return this.emitter.on(t,n),this}});n.from=function(i){return new n(t.Polygon.from(i))}}(function(){return this.jeos}());